# Continue rolling back an update<a name="using-cfn-updating-stacks-continueupdaterollback"></a>

A stack goes into the `UPDATE_ROLLBACK_FAILED` state when AWS CloudFormation cannot roll back all changes during an update\. For example, you might have a stack that begins to roll back to an old database instance that was deleted outside of AWS CloudFormation\. Because AWS CloudFormation doesn't know that the database was deleted, it assumes that the database instance still exists and attempts to roll back to it, causing the update rollback to fail\.

When a stack is in the `UPDATE_ROLLBACK_FAILED` state, you can continue to roll it back to a working state \(`UPDATE_ROLLBACK_COMPLETE`\)\. You can't update a stack that is in the `UPDATE_ROLLBACK_FAILED` state\. However, if you can continue to roll it back, you can return the stack to its original settings and then try to update it again\.

In most cases, you must [fix the error](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/troubleshooting.html#troubleshooting-errors-update-rollback-failed) that causes the update rollback to fail before you can continue to roll back your stack\. In other cases, you can continue to roll back the update without any changes, for example when a stack operation times out\.

**Note**  
If you use nested stacks, rolling back the parent stack will attempt to roll back all the child stacks as well\.

**To continue rolling back an update \(console\)**

1. Open the AWS CloudFormation console at [https://console\.aws\.amazon\.com/cloudformation](https://console.aws.amazon.com/cloudformation/)\.

1. Select the stack that you want to update, choose **Stack actions**, and then choose **Continue update rollback**\.

   If none of the solutions in the [troubleshooting guide](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/troubleshooting.html#troubleshooting-errors-update-rollback-failed) worked, you can use the advanced option to skip the resources that AWS CloudFormation can't successfully roll back\. You must [look up](cfn-console-view-stack-data-resources.md) and type the logical IDs of the resources that you want to skip\. Specify only resources that went into the `UPDATE_FAILED` state during the UpdateRollback and not during the forward update\.
**Warning**  
AWS CloudFormation sets the status of the specified resources to `UPDATE_COMPLETE` and continues to roll back the stack\. After the rollback is complete, the state of the skipped resources will be inconsistent with the state of the resources in the stack template\. Before performing another stack update, you must update the stack or resources to be consistent with each other\. If you don't, subsequent stack updates might fail, and the stack will become unrecoverable\.

   Specify the minimum number of resources required to successfully roll back your stack\. For example, a failed resource update might cause dependent resources to fail\. In this case, it might not be necessary to skip the dependent resources\.

   To skip resources that are part of nested stacks, use the following format: `NestedStackName.ResourceLogicalID`\. If you want to specify the logical ID of a stack resource \(`Type: AWS::CloudFormation::Stack`\) in the `ResourcesToSkip` list, then its corresponding embedded stack must be in one of the following states: `DELETE_IN_PROGRESS`, `DELETE_COMPLETE`, or `DELETE_FAILED`\.

**To continue rolling back an update \(AWS CLI\)**
+ Use the `[aws cloudformation continue\-update\-rollback](https://docs.aws.amazon.com/cli/latest/reference/cloudformation/continue-update-rollback.html)` command with the `stack-name` option to specify the ID of the stack that you want to continue to roll back\.

## Using `ResourcesToSkip` to recover a nested stacks hierarchy<a name="nested-stacks"></a>

The following diagram shows a nested stacks hierarchy that is in the `UPDATE_ROLLBACK_FAILED` state\. In this example, the `WebInfra` root stack has two nested stacks: `WebInfra-Compute` and `WebInfra-Storage`, which in turn have one or more nested stacks\.

![\[A diagram showing a three-level nested stack hierarchy.\]](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/images/cfn-update-stack-continue-update-rollback_nested-stacks.png)

**Note**  
The stack names in this example are truncated for simplicity\. Child stack names are typically generated by AWS CloudFormation and contain unique random strings, so actual names might not be user\-friendly\. 

To successfully get the root stack into an operable state using `continue-update-rollback`, you must use the `resources-to-skip` parameter to skip resources that failed to rollback\. In this example, `resources-to-skip` would include the following items:

1. myCustom

1. WebInfra\-Compute\-Asg\.myAsg

1. WebInfra\-Compute\-LB\.myLoadBalancer

1. WebInfra\-Storage\.DB

The following example is the full CLI command:

```
1. PROMPT> aws cloudformation continue-update-rollback --stack-name WebInfra --resources-to-skip myCustom WebInfra-Compute-Asg.myAsg WebInfra-Compute-LB.myLoadBalancer WebInfra-Storage.DB
```

Note that we specified resources from nested stacks by using the `NestedStackName.ResourceLogicalID` format, but for the resources of the root stack, such as *myCustom*, we specified only the logical ID\.

**Finding the stack name of a nested stack**

You can find a child stack's name in its stack ID or Amazon Resource Name \(ARN\)\. In the following example, the stack name is *WebInfra\-Storage\-Z2VKC706XKXT*:

`arn:aws:cloudformation:us-east-1:123456789012:stack/WebInfra-Storage-Z2VKC706XKXT/ea9e7f90-54f7-11e6-a032-028f3d2330bd`

**Finding the logical ID of a nested stack**

You can find a child stack's logical ID in the template definition of its parent\. In the diagram, the `LogicalId` of the `WebInfra-Storage-DB` child stack is *DB* in its parent `WebInfra-Storage`\.

In the AWS CloudFormation console, you can also find the logical ID in the **Logical ID** column for the stack resource on the **Resources** tab or the **Events** tab\.